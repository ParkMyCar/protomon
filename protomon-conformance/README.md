# protomon-conformance

Conformance test suite for `protomon`. Contains predefined protobuf test cases that exercise edge cases of the protobuf wire format.

## Structure

```
protomon-conformance/
├── protos/               # Proto schema definitions
└── testdata/             # Test cases
    ├── **/*.textproto      # Test input
    ├── **/*.bin            # Binary protobuf encoding (generated by C++)
    └── **/tests.txt        # Manifest listing test cases and their message types
```

## Regenerating Binary Files

After modifying any `.textproto` files, regenerate the binary files:

```bash
cd /path/to/protomon-conformance
bazel run //:generate_binaries -- --input_dir=$(pwd)/testdata --output_dir=$(pwd)/testdata
```

## Adding New Test Cases

### 1. Add the test case definition

Create a new `.textproto` file in the appropriate category directory:

```bash
# Example: testdata/scalars/int32_custom.textproto
value: 12345
```

### 2. Register the test case

Add an entry to the `tests.txt` file in that category:

```
# Format: test_name MessageType
int32_custom Int32Value
```

The message type must match one of the types defined in the proto schemas and registered in `generate_binaries.cpp`.

### 3. Regenerate binaries

```bash
bazel run //:generate_binaries -- --input_dir=$(pwd)/testdata --output_dir=$(pwd)/testdata
```

## Adding New Message Types

### 1. Define the message in a proto file

Edit an existing proto in `protos/` or create a new one:

```protobuf
// protos/scalars.proto
message MyNewMessage {
  int32 field1 = 1;
  string field2 = 2;
}
```

### 2. Register the message type in the generator

Edit `generate_binaries.cpp` and add a dispatch case in `ProcessCategory()`:

```cpp
else if (message_type == "MyNewMessage")
    ok = ProcessTestCase<conformance::MyNewMessage>(textproto_path, bin_path);
```

### 3. If adding a new proto file

Add the proto_library and cc_proto_library targets to `BUILD.bazel`:

```python
proto_library(
    name = "myproto_proto",
    srcs = ["protos/myproto.proto"],
)

cc_proto_library(
    name = "myproto_cc_proto",
    deps = [":myproto_proto"],
)
```

Add the cc_proto_library as a dependency of `generate_binaries`:

```python
cc_binary(
    name = "generate_binaries",
    deps = [
        # ...
        ":myproto_cc_proto",
    ],
)
```

Include the header in `generate_binaries.cpp`:

```cpp
#include "protos/myproto.pb.h"
```

### 4. Rebuild and regenerate

```bash
bazel build //:generate_binaries
bazel run //:generate_binaries -- --input_dir=$(pwd)/testdata --output_dir=$(pwd)/testdata
```
